# 健壯性機制測試指南

本指南提供最容易測試的健壯性機制場景，幫助您快速驗證程序在異常情況下的行為。

## 🚀 快速開始

### 自動化測試（推薦）

```bash
# 1. 編譯程序
cd build
cmake ..
make

# 2. 運行自動化測試腳本
cd ..
./test_robustness.sh
```

測試腳本會自動測試所有場景，並顯示通過/失敗的結果。

---

## 📋 最容易測試的場景（手動測試）

### ⭐⭐⭐ 測試 1: 端口已被占用（最簡單）

**目的：** 驗證服務器正確處理端口已被占用的情況

**步驟：**
```bash
# 終端 1：啟動第一個服務器
cd build
./server
# 應該看到: server listening on 127.0.0.1:9734

# 終端 2：嘗試啟動第二個服務器（應該失敗）
cd build
./server
# 應該看到: [ERROR] bind() failed
#           bind: Address already in use
# 程序應該退出，不會崩潰
```

**預期結果：**
- ✅ 第二個服務器檢測到端口已被占用
- ✅ 記錄錯誤訊息並優雅退出
- ✅ 第一個服務器繼續正常運行

**如果沒有健壯性機制：**
- ❌ 可能崩潰或進入錯誤狀態
- ❌ 錯誤訊息不明確

---

### ⭐⭐⭐ 測試 2: 客戶端突然斷開連接（最簡單）

**目的：** 驗證服務器在客戶端斷開時不會崩潰

**步驟：**
```bash
# 終端 1：啟動服務器
cd build
./server

# 終端 2：連接後立即斷開
nc 127.0.0.1 9734 &
sleep 0.1
killall nc

# 檢查終端 1 的服務器日誌
# 應該看到類似：
# [WARN] Client closed connection before sending command
# 或
# [ERROR] Error reading from client (client may have disconnected)
```

**預期結果：**
- ✅ 服務器檢測到客戶端斷開
- ✅ 記錄警告/錯誤訊息
- ✅ 服務器繼續運行，可以接受新連接

**驗證服務器仍在運行：**
```bash
# 終端 2：再次連接（應該成功）
cd build
./client SYSINFO
# 應該收到系統資訊回應
```

**如果沒有健壯性機制：**
- ❌ 可能收到 SIGPIPE 信號導致崩潰
- ❌ 資源（進程、socket）洩漏
- ❌ 服務器無法繼續服務

---

### ⭐⭐ 測試 3: 超長輸入處理

**目的：** 驗證服務器正確處理超過緩衝區大小的輸入

**步驟：**
```bash
# 終端 1：啟動服務器
cd build
./server

# 終端 2：發送超長命令（超過 256 字節）
python3 -c "print('A' * 300)" | nc 127.0.0.1 9734

# 檢查終端 1 的服務器日誌
# 應該看到：
# [WARN] Command line too long, may be truncated
```

**預期結果：**
- ✅ 檢測到超長輸入
- ✅ 記錄警告訊息
- ✅ 清空輸入緩衝區
- ✅ 服務器繼續運行

**如果沒有健壯性機制：**
- ❌ 未檢測緩衝區溢出風險
- ❌ 後續讀取可能讀到錯誤數據
- ❌ 可能導致邏輯錯誤或安全問題

---

### ⭐⭐ 測試 4: 空命令處理

**目的：** 驗證服務器正確處理空命令

**步驟：**
```bash
# 終端 1：啟動服務器
cd build
./server

# 終端 2：發送空命令
echo "" | nc 127.0.0.1 9734
# 或
printf "\n" | nc 127.0.0.1 9734

# 應該收到：
# Error: Empty command
```

**預期結果：**
- ✅ 檢測到空命令
- ✅ 發送錯誤訊息給客戶端
- ✅ 正確清理資源
- ✅ 服務器繼續運行

**如果沒有健壯性機制：**
- ❌ 空命令被當作普通命令處理
- ❌ 可能導致意外的行為
- ❌ 浪費資源處理無效請求

---

### ⭐ 測試 5: 客戶端連接超時

**目的：** 驗證服務器設置超時，防止資源被無限期佔用

**步驟：**
```bash
# 終端 1：啟動服務器
cd build
./server

# 終端 2：連接但不發送任何數據（等待 30 秒以上）
nc 127.0.0.1 9734
# 不輸入任何內容，等待...

# 檢查終端 1 的服務器日誌（30秒後）
# 應該看到：
# [WARN] No command received (timeout or empty input), sending default system info
```

**預期結果：**
- ✅ 30 秒後檢測到超時
- ✅ 記錄警告訊息
- ✅ 服務器繼續運行，可以處理新連接

**如果沒有健壯性機制：**
- ❌ 子進程無限期阻塞在 `fgets()`
- ❌ 資源（進程、socket）被佔用
- ❌ 無法處理其他連接請求
- ❌ 可能導致服務器資源耗盡

---

### ⭐ 測試 6: 多個客戶端同時連接

**目的：** 驗證服務器可以同時處理多個連接

**步驟：**
```bash
# 終端 1：啟動服務器
cd build
./server

# 終端 2：同時啟動多個客戶端
for i in {1..5}; do
    (echo "SYSINFO"; sleep 0.1) | timeout 5 ./client > /tmp/client_$i.log 2>&1 &
done
wait

# 檢查所有客戶端是否都收到回應
for i in {1..5}; do
    echo "Client $i:"
    grep -q "System Info\|Hostname" /tmp/client_$i.log && echo "  ✓ 成功" || echo "  ✗ 失敗"
done
```

**預期結果：**
- ✅ 服務器成功處理多個同時連接
- ✅ 大部分客戶端（至少 4/5）成功收到回應
- ✅ 服務器繼續運行

---

## 🔍 如何觀察測試結果

### 查看服務器日誌

服務器會將日誌輸出到標準錯誤（stderr）。要查看詳細日誌：

```bash
# 啟動服務器並保存日誌
cd build
./server 2> /tmp/server.log

# 在另一個終端查看日誌
tail -f /tmp/server.log
```

### 啟用調試日誌

```bash
# 使用環境變數啟用調試
DEBUG_LOG=1 DEBUG_LOG_LEVEL=3 ./server

# 或使用命令行參數
./server --debug 3
```

### 檢查服務器進程

```bash
# 檢查服務器是否在運行
ps aux | grep server

# 檢查是否有殭屍進程
ps aux | grep '<defunct>'

# 檢查 socket 連接
netstat -an | grep 9734
# 或
ss -an | grep 9734
```

---

## 📊 測試結果對比

### 有健壯性機制 vs 沒有健壯性機制

| 測試場景 | 有機制 | 沒有機制 |
|---------|--------|----------|
| 端口占用 | ✅ 優雅退出，記錄錯誤 | ❌ 可能崩潰或錯誤狀態 |
| 客戶端斷開 | ✅ 檢測並繼續運行 | ❌ 可能收到 SIGPIPE 崩潰 |
| 超長輸入 | ✅ 檢測並警告 | ❌ 未檢測，可能邏輯錯誤 |
| 空命令 | ✅ 驗證並拒絕 | ❌ 可能意外處理 |
| 連接超時 | ✅ 30秒超時，繼續運行 | ❌ 無限期阻塞 |
| 多客戶端 | ✅ 並發處理 | ❌ 可能資源耗盡 |

---

## 🛠️ 故障排除

### 問題：測試腳本無法運行

```bash
# 確保腳本有執行權限
chmod +x test_robustness.sh

# 確保程序已編譯
cd build
cmake ..
make
```

### 問題：端口已被占用

```bash
# 查找占用端口的進程
lsof -i :9734
# 或
netstat -tulpn | grep 9734

# 終止進程
kill <PID>
```

### 問題：服務器無法啟動

```bash
# 檢查編譯錯誤
cd build
make clean
cmake ..
make

# 檢查依賴
ldd ./server
```

---

## 📝 總結

這些測試場景展示了健壯性機制的關鍵價值：

1. **優雅降級** - 單個操作失敗不影響整體服務
2. **資源清理** - 所有錯誤路徑都正確清理資源
3. **錯誤檢測** - 及時發現並記錄錯誤
4. **服務連續性** - Server 在各種錯誤情況下保持運行
5. **超時處理** - 防止資源被無限期佔用
6. **輸入驗證** - 防止緩衝區溢出和無效輸入

**推薦測試順序：**
1. 端口占用（最簡單，立即看到效果）
2. 客戶端斷開（最常見的異常情況）
3. 超長輸入（驗證輸入驗證機制）
4. 空命令（驗證參數驗證）
5. 連接超時（驗證超時機制）

---

最後更新：2024年12月

